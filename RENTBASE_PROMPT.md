# Project: RentBase (MVP) - The "Carfax for Rentals" in Africa

## 1. Role & Objective
You are an expert Full-Stack Developer specializing in **Nuxt 3** and **Supabase**. Your goal is to build the MVP for "RentBase," a mobile-first web app that allows renters in Ghana to verify agents, generate legal contracts, and protect their deposits.

**Key Requirement:** The app must use **Phone Number via SMS OTP** (Supabase Auth) for login and **Paystack** for payments.

---

## 2. Tech Stack Constraints
| Layer | Technology |
|-------|------------|
| **Framework** | Nuxt 3 (SSR enabled) |
| **Backend/DB** | Supabase (PostgreSQL, Auth, Edge Functions, Storage) |
| **Auth Provider** | Supabase Phone Auth (OTP) |
| **Payments** | Paystack (Inline Popup method) |
| **Styling** | TailwindCSS (Mobile-first, clean, minimal) |
| **PDF Generation** | `jspdf` (Client-side generation) |
| **Language** | TypeScript |

---

## 3. Core Features to Build (Phase 1)

### 3.1 Home Page (Search)
A minimalist search bar to check an Agent's Phone Number. Display a trust score indicator:
- ðŸ”´ **Red:** No reviews or negative reviews
- ðŸŸ¡ **Yellow:** Mixed reviews (2-3 stars average)
- ðŸŸ¢ **Green:** Positive reviews (4-5 stars average)

### 3.2 SMS Auth Flow
- Modal triggers when accessing paid features.
- Handle E.164 formatting (default `+233` for Ghana).
- Supabase Phone OTP flow â†’ Profile auto-creation on signup.

### 3.3 Feature A: "Pocket Lawyer" (Tenancy Agreement Generator)
| Step | Action | Details |
|------|--------|---------|
| **1. Input** | User fills form | Landlord/Tenant details, Rent, Duration, Terms |
| **2. Draft** | User clicks "Generate Draft" | Creates public, read-only link (`/contract/preview/[uuid]`) with **"DRAFT - NOT VALID"** watermark. User can share link via WhatsApp for landlord approval. |
| **3. Payment** | User clicks "Finalize & Download" | **Paystack Modal (GHâ‚µ 40)** â†’ On success: remove watermark, mark `is_finalized = true`, download official PDF. |

### 3.4 Feature B: "Deposit Shield" (Move-In Snapshot)
| Step | Action | Details |
|------|--------|---------|
| **1. Upload** | User captures/uploads photos | Upload defect photos to Supabase Storage with descriptions |
| **2. Review** | User reviews photos | Preview all uploaded images with descriptions |
| **3. Payment** | User clicks "Generate Report" | **Paystack Modal (GHâ‚µ 25)** â†’ On success: generate timestamped PDF report with all images, mark `is_finalized = true`. |

---

## 4. Database Schema (Supabase)

### Initial SQL Migration

```sql
-- ============================================
-- 1. PROFILES (Synced with Auth)
-- ============================================
create table public.profiles (
  id uuid references auth.users on delete cascade primary key,
  phone_number text unique not null,
  role text default 'renter' check (role in ('renter', 'agent', 'admin')),
  is_verified boolean default false,
  created_at timestamptz default now()
);

-- ============================================
-- 2. REVIEWS (Agent Checker)
-- ============================================
create table public.reviews (
  id bigint generated by default as identity primary key,
  agent_phone text not null,
  reviewer_id uuid references public.profiles(id),
  rating int check (rating >= 1 and rating <= 5),
  comment text,
  created_at timestamptz default now()
);

-- Index for fast agent lookup
create index idx_reviews_agent_phone on public.reviews (agent_phone);

-- ============================================
-- 3. TRANSACTIONS (Paystack Ledger)
-- ============================================
create table public.transactions (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id),
  reference text unique not null, -- Paystack Reference
  amount numeric not null,
  status text default 'pending' check (status in ('pending', 'success', 'failed')),
  feature_type text not null check (feature_type in ('contract', 'deposit_report')),
  created_at timestamptz default now()
);

-- ============================================
-- 4. CONTRACTS (Pocket Lawyer)
-- ============================================
create table public.contracts (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id),
  payment_ref text references public.transactions(reference),
  details jsonb, -- Store form inputs
  is_finalized boolean default false, -- False = Draft Mode
  created_at timestamptz default now()
);

-- ============================================
-- 5. CONDITION REPORTS (Deposit Shield)
-- ============================================
create table public.condition_reports (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id),
  payment_ref text references public.transactions(reference),
  is_finalized boolean default false,
  report_date timestamptz default now()
);

create table public.report_images (
  id bigint generated by default as identity primary key,
  report_id uuid references public.condition_reports(id) on delete cascade,
  image_url text not null,
  defect_description text
);

-- ============================================
-- 6. AUTO-CREATE PROFILE ON SIGNUP (Trigger)
-- ============================================
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.profiles (id, phone_number)
  values (new.id, new.phone);
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute function public.handle_new_user();

-- ============================================
-- 7. ROW LEVEL SECURITY (RLS)
-- ============================================

-- Enable RLS on all tables
alter table public.profiles enable row level security;
alter table public.reviews enable row level security;
alter table public.transactions enable row level security;
alter table public.contracts enable row level security;
alter table public.condition_reports enable row level security;
alter table public.report_images enable row level security;

-- PROFILES Policies
create policy "Users can view own profile"
  on public.profiles for select
  using (auth.uid() = id);

create policy "Users can update own profile"
  on public.profiles for update
  using (auth.uid() = id);

-- REVIEWS Policies
create policy "Anyone can read reviews"
  on public.reviews for select
  using (true);

create policy "Authenticated users can create reviews"
  on public.reviews for insert
  with check (auth.uid() = reviewer_id);

-- TRANSACTIONS Policies
create policy "Users can view own transactions"
  on public.transactions for select
  using (auth.uid() = user_id);

create policy "Users can create transactions"
  on public.transactions for insert
  with check (auth.uid() = user_id);

-- CONTRACTS Policies
create policy "Users can view own contracts"
  on public.contracts for select
  using (auth.uid() = user_id);

create policy "Public can preview drafts by ID"
  on public.contracts for select
  using (is_finalized = false);

create policy "Users can create contracts"
  on public.contracts for insert
  with check (auth.uid() = user_id);

create policy "Users can update own contracts"
  on public.contracts for update
  using (auth.uid() = user_id);

-- CONDITION REPORTS Policies
create policy "Users can view own reports"
  on public.condition_reports for select
  using (auth.uid() = user_id);

create policy "Users can create reports"
  on public.condition_reports for insert
  with check (auth.uid() = user_id);

create policy "Users can update own reports"
  on public.condition_reports for update
  using (auth.uid() = user_id);

-- REPORT IMAGES Policies
create policy "Users can view own report images"
  on public.report_images for select
  using (
    report_id in (
      select id from public.condition_reports where user_id = auth.uid()
    )
  );

create policy "Users can insert report images"
  on public.report_images for insert
  with check (
    report_id in (
      select id from public.condition_reports where user_id = auth.uid()
    )
  );

create policy "Users can delete own report images"
  on public.report_images for delete
  using (
    report_id in (
      select id from public.condition_reports where user_id = auth.uid()
    )
  );
```

---

## 5. Supabase Storage Bucket

```sql
-- Create storage bucket for deposit photos
insert into storage.buckets (id, name, public)
values ('deposit-photos', 'deposit-photos', true);

-- Storage policy: Users can upload to their own folder
create policy "Users can upload deposit photos"
  on storage.objects for insert
  with check (
    bucket_id = 'deposit-photos' and
    auth.uid()::text = (storage.foldername(name))[1]
  );

-- Storage policy: Anyone can view photos (for report generation)
create policy "Public can view deposit photos"
  on storage.objects for select
  using (bucket_id = 'deposit-photos');
```

---

## 6. Environment Variables Required

```env
# Supabase
NUXT_PUBLIC_SUPABASE_URL=your_supabase_url
NUXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Paystack
NUXT_PUBLIC_PAYSTACK_PUBLIC_KEY=pk_live_xxx
PAYSTACK_SECRET_KEY=sk_live_xxx

# App
NUXT_PUBLIC_APP_URL=https://rentbase.app
```

---

## 7. Key Implementation Notes

### Phone Auth (E.164 Formatting)
```typescript
// Utility to format Ghana phone numbers
function formatPhoneE164(phone: string): string {
  // Remove all non-digits
  const digits = phone.replace(/\D/g, '');
  
  // If starts with 0, replace with +233
  if (digits.startsWith('0')) {
    return `+233${digits.slice(1)}`;
  }
  
  // If starts with 233, add +
  if (digits.startsWith('233')) {
    return `+${digits}`;
  }
  
  // If 9 digits, assume local number
  if (digits.length === 9) {
    return `+233${digits}`;
  }
  
  return `+${digits}`;
}
```

### Paystack Integration (Inline Popup)
```typescript
// composables/usePaystack.ts
export function usePaystack() {
  const config = useRuntimeConfig();
  
  const pay = (options: {
    email: string;
    amount: number; // In pesewas (GHâ‚µ 40 = 4000)
    reference: string;
    onSuccess: (reference: string) => void;
    onClose: () => void;
  }) => {
    const handler = PaystackPop.setup({
      key: config.public.paystackPublicKey,
      email: options.email,
      amount: options.amount,
      currency: 'GHS',
      ref: options.reference,
      callback: (response) => options.onSuccess(response.reference),
      onClose: options.onClose,
    });
    handler.openIframe();
  };
  
  return { pay };
}
```

### PDF Generation with Watermark
```typescript
// utils/generateContractPDF.ts
import { jsPDF } from 'jspdf';

export function generateContractPDF(
  contract: ContractDetails,
  isDraft: boolean
): jsPDF {
  const doc = new jsPDF();
  
  if (isDraft) {
    // Add watermark
    doc.setTextColor(200, 200, 200);
    doc.setFontSize(60);
    doc.text('DRAFT - NOT VALID', 105, 150, {
      align: 'center',
      angle: 45,
    });
    doc.setTextColor(0, 0, 0);
  }
  
  // Add contract content...
  doc.setFontSize(12);
  doc.text(`Tenancy Agreement`, 105, 20, { align: 'center' });
  // ... rest of content
  
  return doc;
}
```

---

## 8. Pricing Summary

| Feature | Price (GHâ‚µ) | Price (Pesewas) |
|---------|-------------|-----------------|
| Pocket Lawyer (Contract) | 40 | 4000 |
| Deposit Shield (Report) | 25 | 2500 |

---

## 9. Project Structure

```
rentbase/
â”œâ”€â”€ nuxt.config.ts
â”œâ”€â”€ app.vue
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ index.vue                    # Home (Agent Search)
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ verify.vue               # OTP Verification
â”‚   â”œâ”€â”€ contract/
â”‚   â”‚   â”œâ”€â”€ new.vue                  # Contract Form
â”‚   â”‚   â””â”€â”€ preview/[id].vue         # Public Draft Preview
â”‚   â””â”€â”€ deposit/
â”‚       â”œâ”€â”€ new.vue                  # Photo Upload
â”‚       â””â”€â”€ review/[id].vue          # Review & Pay
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ AuthModal.vue                # Phone OTP Modal
â”‚   â”œâ”€â”€ AgentSearchBar.vue
â”‚   â”œâ”€â”€ TrustScoreBadge.vue
â”‚   â”œâ”€â”€ ContractForm.vue
â”‚   â”œâ”€â”€ PhotoUploader.vue
â”‚   â””â”€â”€ PaystackButton.vue
â”œâ”€â”€ composables/
â”‚   â”œâ”€â”€ useAuth.ts
â”‚   â”œâ”€â”€ usePaystack.ts
â”‚   â””â”€â”€ useContractGenerator.ts
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ paystack/
â”‚   â”‚       â””â”€â”€ webhook.post.ts      # Verify payments
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ supabase.ts
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ formatPhone.ts
â”‚   â””â”€â”€ generatePDF.ts
â””â”€â”€ types/
    â””â”€â”€ index.ts
```

---

This prompt is complete with all necessary schema, security policies, storage configuration, and implementation guidance. Ready for development! ðŸš€
